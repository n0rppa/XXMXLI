<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Auto Music Library</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css?family=Barlow:400,700|Barlow+Condensed:700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
<style>
body {
  font-family: 'Barlow', sans-serif;
  background: #181818;
  color: #e8e8f0;
  margin: 0;
  padding: 0;
}
.wrapper {
  max-width: 480px;
  margin: 40px auto;
  background: #23232c;
  border-radius: 18px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.25);
  overflow: hidden;
}
.content {
  padding: 20px 20px 30px 20px;
}
.menuBar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
}
.menuBar .appName {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 1.4em;
  font-weight: 700;
  letter-spacing: 2px;
  color: #ffedc0;
  margin: 0;
}
.musicGroups { margin-top: 24px; }
ul.song-list {
  list-style: none;
  padding: 0; margin: 0;
}
ul.song-list li {
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  background: #222234;
  border-radius: 12px;
  padding: 12px;
  cursor: pointer;
  transition: background 0.15s;
}
ul.song-list li.active { background: #ffedc0; color: #23232c; }
.song-cover {
  width: 50px; height: 50px;
  border-radius: 8px;
  background-size: cover;
  background-position: center;
  margin-right: 14px;
  flex-shrink: 0;
  background-color: #444;
}
.song-info { flex: 1 1 auto; min-width: 0; }
.song-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 1.13em;
  font-weight: 700;
  margin-bottom: 2px;
  color: inherit;
  text-overflow: ellipsis;
  overflow: hidden;
  white-space: nowrap;
}
.song-artist {
  font-size: 0.95em;
  color: #b0b0c0;
  text-overflow: ellipsis;
  overflow: hidden;
  white-space: nowrap;
}
.song-meta {
  font-size: 0.82em;
  color: #9a9aaf;
  margin-top: 1px;
}
.song-duration {
  margin-left: 12px;
  font-size: 0.98em;
  color: #aeea00;
  min-width: 46px;
  text-align: right;
}
.song-play {
  margin-left: 12px;
  background: #ffedc0;
  color: #23232c;
  border: none;
  border-radius: 50%;
  width: 36px; height: 36px;
  font-size: 1.3em;
  cursor: pointer;
  transition: background 0.2s;
}
.song-play:hover { background: #ffe08c; }
.player-controls {
  margin-top: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 18px;
}
.player-controls button {
  background: #23232c;
  color: #ffedc0;
  border: none;
  border-radius: 50%;
  width: 36px; height: 36px;
  font-size: 1.2em;
  cursor: pointer;
  transition: background 0.2s;
}
.player-controls button:hover { background: #ffedc0; color: #23232c; }
#now-playing {
  margin-top: 16px;
  text-align: center;
  color: #ffedc0;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 1.1em;
  min-height: 1.5em;
}
audio {
  width: 100%;
  margin-top: 16px;
  outline: none;
  background: #23232c;
  border-radius: 8px;
}
.visualizer-container {
  width: 100%;
  height: 90px;
  margin: 18px 0 0 0;
  background: #111;
  border-radius: 8px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}
#visualizer {
  width: 100%;
  height: 100%;
  display: block;
  background: #000;
}
@media (max-width: 520px) {
  .wrapper { margin: 20px 2vw 0 2vw; }
  .content { padding: 10px 3vw 18px 3vw; }
}
</style>
</head>
<body>
<div class="wrapper">
  <div class="content">
    <div class="menuBar">
      <p class="appName">Your Library</p>
    </div>
    <div class="musicGroups">
      <ul class="song-list" id="song-list"></ul>
      <div class="player-controls">
        <button id="prev-btn" title="Previous">&#9198;</button>
        <button id="play-btn" title="Play/Pause">&#9658;</button>
        <button id="next-btn" title="Next">&#9197;</button>
      </div>
      <div id="now-playing"></div>
      <audio id="audio" controls preload="metadata"></audio>
      <div class="visualizer-container">
        <canvas id="visualizer"></canvas>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jsmediatags/dist/jsmediatags.min.js"></script>
<script>
const AUDIO_DIR = "assets/audio/";
const DEFAULT_COVER = "https://source.unsplash.com/80x80/?music,vinyl";
const AUDIO_EXTS = [".mp3",".flac",".ogg",".wav"];
let songs = [];
let current = 0;

const audio = document.getElementById('audio');
const songList = document.getElementById('song-list');
const nowPlaying = document.getElementById('now-playing');
const playBtn = document.getElementById('play-btn');
const nextBtn = document.getElementById('next-btn');
const prevBtn = document.getElementById('prev-btn');
const visualizerCanvas = document.getElementById('visualizer');
let audioCtx, analyser, source, animationId;

function formatTime(sec) {
  if (!sec || isNaN(sec)) return "--:--";
  sec = Math.floor(sec);
  return `${Math.floor(sec/60)}:${(sec%60).toString().padStart(2,"0")}`;
}

// Read metadata (title, artist, album, coverart, duration)
async function extractMetadata(file) {
  return new Promise(resolve => {
    const src = AUDIO_DIR + file;
    let song = { src, file, title: file, artist: "", album: "", duration: "", cover: DEFAULT_COVER };
    // jsmediatags
    window.jsmediatags.read(src, {
      onSuccess: tag => {
        if (tag.tags.title) song.title = tag.tags.title;
        if (tag.tags.artist) song.artist = tag.tags.artist;
        if (tag.tags.album) song.album = tag.tags.album;
        // Cover art
        if (tag.tags.picture) {
          const pic = tag.tags.picture;
          let base64String = "";
          for (let i = 0; i < pic.data.length; i++) {
            base64String += String.fromCharCode(pic.data[i]);
          }
          song.cover = `data:${pic.format};base64,${btoa(base64String)}`;
        }
        resolve(song);
      },
      onError: () => resolve(song)
    });
    // Duration
    const tempAudio = document.createElement('audio');
    tempAudio.src = src;
    tempAudio.preload = 'metadata';
    tempAudio.addEventListener('loadedmetadata', function() {
      if (!isNaN(tempAudio.duration)) {
        song.duration = formatTime(tempAudio.duration);
      }
    });
  });
}

async function getSongFiles() {
  let files = [];
  try {
    const res = await fetch(AUDIO_DIR + "tracklist.json");
    if (res.ok) {
      files = await res.json();
      if (files.length && typeof files[0] === "string") files = files.map(f => ({ file: f }));
      files = files.map(f => f.file || f);
    }
  } catch (e) {}
  if (!files.length) {
    alert("tracks not found - make sure assets/audio/tracklist.json exists!");
    return [];
  }
  return files.filter(f => AUDIO_EXTS.some(ext => f.toLowerCase().endsWith(ext)));
}

async function loadSongs() {
  const files = await getSongFiles();
  // Show loading
  songList.innerHTML = `<li>Loading songs...</li>`;
  songs = await Promise.all(files.map(extractMetadata));
  // Sort by file name
  songs.sort((a,b) => a.file.localeCompare(b.file));
  renderList();
  playSong(0);
}

function renderList() {
  songList.innerHTML = '';
  songs.forEach((song, idx) => {
    const li = document.createElement('li');
    if (idx === current) li.className = 'active';
    // Cover
    const img = document.createElement('div');
    img.className = 'song-cover';
    img.style.backgroundImage = `url('${song.cover || DEFAULT_COVER}')`;
    li.appendChild(img);
    // Info
    const info = document.createElement('div');
    info.className = 'song-info';
    info.innerHTML = `<div class="song-title">${song.title || song.file}</div>
      <div class="song-artist">${song.artist || ""}</div>
      <div class="song-meta">${song.album || ""}</div>`;
    li.appendChild(info);
    // Duration
    const dur = document.createElement('div');
    dur.className = 'song-duration';
    dur.textContent = song.duration || '--:--';
    li.appendChild(dur);
    // Play
    const btn = document.createElement('button');
    btn.className = 'song-play';
    btn.innerHTML = (idx === current && !audio.paused) ? '&#10073;&#10073;' : '&#9658;';
    btn.onclick = (e) => {
      e.stopPropagation();
      if (current === idx) {
        if (audio.paused) audio.play();
        else audio.pause();
      } else {
        playSong(idx);
      }
    };
    li.appendChild(btn);
    li.onclick = () => playSong(idx);
    songList.appendChild(li);
  });
}

function playSong(idx) {
  if (!songs[idx]) return;
  current = idx;
  audio.src = songs[idx].src;
  audio.play();
  updateUI();
}
function updateUI() {
  renderList();
  nowPlaying.innerHTML = `<span>${songs[current].title || songs[current].file}${songs[current].artist ? ` â€” ${songs[current].artist}` : ""}${songs[current].album ? ` <span style="color:#bdbd00;">(${songs[current].album})</span>` : ""}</span>`;
}

audio.addEventListener('ended', () => { nextSong(); });
audio.addEventListener('play', updateUI);
audio.addEventListener('pause', updateUI);

function nextSong() { current = (current + 1) % songs.length; playSong(current);}
function prevSong() { current = (current - 1 + songs.length) % songs.length; playSong(current);}
playBtn.onclick = () => { if (audio.paused) audio.play(); else audio.pause(); };
nextBtn.onclick = nextSong;
prevBtn.onclick = prevSong;

// -- SIMPLE VISUALIZER --
function startVisualizer() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    source = audioCtx.createMediaElementSource(audio);
    analyser = audioCtx.createAnalyser();
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
  }
  drawVisualizer();
}
function drawVisualizer() {
  const ctx = visualizerCanvas.getContext('2d');
  analyser.fftSize = 64;
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  ctx.clearRect(0,0,visualizerCanvas.width,visualizerCanvas.height);
  analyser.getByteFrequencyData(dataArray);
  const w = visualizerCanvas.width / bufferLength;
  for (let i=0;i<bufferLength;i++) {
    const val = dataArray[i];
    ctx.fillStyle = `rgb(${100+val},${val},${200-val})`;
    ctx.fillRect(i*w, visualizerCanvas.height-val/2, w-2, val/2);
  }
  animationId = requestAnimationFrame(drawVisualizer);
}
audio.addEventListener('play', () => {
  if (!audioCtx) startVisualizer();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  drawVisualizer();
});
audio.addEventListener('pause', () => { if (animationId) cancelAnimationFrame(animationId); });
window.addEventListener('resize', () => {
  visualizerCanvas.width = visualizerCanvas.offsetWidth;
  visualizerCanvas.height = visualizerCanvas.offsetHeight;
});
window.addEventListener('DOMContentLoaded', () => {
  visualizerCanvas.width = visualizerCanvas.offsetWidth;
  visualizerCanvas.height = visualizerCanvas.offsetHeight;
  loadSongs();
});
</script>
</body>
</html>